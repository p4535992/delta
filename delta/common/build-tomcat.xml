<?xml version="1.0" encoding="UTF-8"?>
<project name="tomcat" basedir=".">

   <import file="build-common.xml" />

   <target name="setup-tomcat" depends="load-conf">
      <echo message="Copying configuration file to Tomcat classpath" />
      <copy todir="${dir.tomcat.classes}" preservelastmodified="true" overwrite="true">
         <fileset dir="${conf.basedir}/${conf.name}/classes" />
      </copy>
   </target>

   <target name="tomcat-start" depends="setup-tomcat" description="Start Tomcat server">
      <condition property="tomcat.start.done">
         <http url="http://${server.host}:${server.domain.port}/" />
      </condition>
      <fail if="tomcat.start.done" message="Tomcat server is already started, please stop it first" />

      <echo message="Starting Tomcat" />
      <exec executable="${dir.tomcat}/tomcat${executable.tomcat.extension}" failonerror="true">
         <arg value="start" />
      </exec>
      <echo message="Wait for the server start (see ${dir.tomcat}/logs/catalina.out)" />
      <waitfor maxwait="120" maxwaitunit="second" checkevery="2" checkeveryunit="second" timeoutproperty="wait.timeout">
         <http url="http://${server.host}:${server.domain.port}/" />
      </waitfor>
      <fail if="wait.timeout"
            message="Didn't get response from deployment management url: http://${server.host}:${server.domain.port}." />
      <echo message="Server started - see http://${server.host}:${server.domain.port}" />
   </target>

   <target name="tomcat-stop" depends="load-conf" description="Stop tomcat server domain">
      <echo message="Stopping Tomcat" />
      <exec executable="${dir.tomcat}/tomcat${executable.tomcat.extension}" failonerror="true">
         <arg value="stop" />
      </exec>
   </target>

   <target name="deploy" depends="compile, tomcat-start" description="Compile sources and start Tomcat server" />

   <target name="redeploy" depends="tomcat-stop, deploy" description="Stop Tomcat, compile sources and start Tomcat" />

   <target name="clean-redeploy"
           depends="tomcat-stop, clean-all, deploy"
           description="Stop Tomcat, clean, rebuild and start Tomcat server" />

</project>
